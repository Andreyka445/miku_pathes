From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Tue, 23 Nov 2021 16:14:57 +0200
Subject: [PATCH] core: Allow overriding device/model/name/fingerprint
 properties

Change-Id: I84c4ecb4d20fe6954551e4f07f739e04bfffd647
Signed-off-by: fukiame <fukiame@proton.me>

diff --git a/core/sysprop.mk b/core/sysprop.mk
index 2462d55eb76795d1520260718038f29aa9a86a44..a72f3c5f3c2e496661bb3cca41c10be0d0a28c47 100644
--- a/core/sysprop.mk
+++ b/core/sysprop.mk
@@ -29,22 +29,17 @@ POST_PROCESS_PROPS := $(HOST_OUT_EXECUTABLES)/post_process_props$(HOST_EXECUTABL
 # $(1): Partition name
 # $(2): Output file name
 define generate-common-build-props
-    PRODUCT_NAME="$(TARGET_PRODUCT)";\
-    PRODUCT_DEVICE="$(TARGET_DEVICE)";\
+    bash -c '\
     $(or $(PRODUCT_BUILD_PROP_OVERRIDES),:);\
-    PRODUCT_SYSTEM_NAME=$(PRODUCT_SYSTEM_NAME);\
-    PRODUCT_SYSTEM_DEVICE=$(PRODUCT_SYSTEM_DEVICE);\
-    [ "$(PRODUCT_SYSTEM_DEVICE)" = "$(TARGET_DEVICE)" ] && PRODUCT_SYSTEM_DEVICE=$${PRODUCT_DEVICE};\
-    [ "$(PRODUCT_SYSTEM_NAME)" = "$(TARGET_PRODUCT)" ] && PRODUCT_SYSTEM_NAME=$${PRODUCT_NAME};\
     echo "####################################" >> $(2);\
     echo "# from generate-common-build-props" >> $(2);\
     echo "# These properties identify this partition image." >> $(2);\
     echo "####################################" >> $(2);\
     echo "ro.product.$(1).brand=$(PRODUCT_BRAND)" >> $(2);\
-    echo "ro.product.$(1).device=$${PRODUCT_DEVICE}" >> $(2);\
+    echo "ro.product.$(1).device=$${DeviceName:-$(TARGET_DEVICE)}" >> $(2);\
     echo "ro.product.$(1).manufacturer=$(PRODUCT_MANUFACTURER)" >> $(2);\
-    echo "ro.product.$(1).model=$(PRODUCT_MODEL)" >> $(2);\
-    echo "ro.product.$(1).name=$${PRODUCT_NAME}" >> $(2);\
+    echo "ro.product.$(1).model=$${ProductModel:-$(PRODUCT_MODEL)}" >> $(2);\
+    echo "ro.product.$(1).name=$${DeviceProduct:-$(TARGET_PRODUCT)}" >> $(2);\
     if [ -n "$(strip $(PRODUCT_MODEL_FOR_ATTESTATION))" ]; then \
         echo "ro.product.model_for_attestation=$(PRODUCT_MODEL_FOR_ATTESTATION)" >> $(2);\
     fi; \
@@ -75,10 +70,7 @@ define generate-common-build-props
     )\
     echo "ro.$(1).build.date=`$(DATE_FROM_FILE)`" >> $(2);\
     echo "ro.$(1).build.date.utc=`$(DATE_FROM_FILE) +%s`" >> $(2);\
-    # Allow optional assignments for ARC forward-declarations (b/249168657)
-    # TODO: Remove any tag-related inconsistencies once the goals from
-    # go/arc-android-sigprop-changes have been achieved.
-    echo "ro.$(1).build.fingerprint?=$(BUILD_FINGERPRINT_FROM_FILE)" >> $(2);\
+    echo "ro.$(1).build.fingerprint?=$${BuildFingerprint:-$(BUILD_FINGERPRINT_FROM_FILE)}" >> $(2);\
     echo "ro.$(1).build.id?=$(BUILD_ID)" >> $(2);\
     echo "ro.$(1).build.tags?=$(BUILD_VERSION_TAGS)" >> $(2);\
     echo "ro.$(1).build.type=$(TARGET_BUILD_VARIANT)" >> $(2);\
@@ -87,6 +79,7 @@ define generate-common-build-props
     echo "ro.$(1).build.version.release_or_codename=$(PLATFORM_VERSION)" >> $(2);\
     echo "ro.$(1).build.version.sdk=$(PLATFORM_SDK_VERSION)" >> $(2);\
     echo "ro.$(1).build.version.sdk_full=$(PLATFORM_SDK_VERSION_FULL)" >> $(2);\
+    ';\
 
 endef
 
